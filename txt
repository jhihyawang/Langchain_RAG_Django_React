# tasks.py
import json

import fitz  # PyMuPDF
from background_task import background
from common.modules.processor.pdf_processor import PdfProcessor
from common.modules.processor.vector_store import VectorStoreHandler
from enterprise_assistant.models import Knowledge


@background(schedule=5)
def process_pdf_background(knowledge_id):
    try:
        knowledge = Knowledge.objects.get(id=knowledge_id)

        # âœ… è‹¥æª”æ¡ˆä¸å­˜åœ¨ï¼ˆå¯èƒ½è¢«åˆªé™¤ï¼‰ï¼Œè‡ªå‹•è·³é
        if not knowledge.file or not os.path.exists(knowledge.file.path):
            print(f"âŒ æª”æ¡ˆä¸å­˜åœ¨ï¼Œè·³éè™•ç†ï¼šKnowledge ID {knowledge_id}")
            knowledge.processing_status = "error"
            knowledge.save()
        else:
            # âœ… è¨­ç‚ºè™•ç†ä¸­
            knowledge.processing_status = "processing"
            knowledge.save()

            # âœ… PDF è™•ç†
            processor = PdfProcessor(pdf_path=knowledge.file.path, knowledge_id=knowledge_id)
            result = processor.optimized_process()

            # âœ… å¯«å…¥å‘é‡åº«
            vectorstore = VectorStoreHandler("chroma_user_db")

            for media_type in ["text", "table", "image"]:
                for item in result.get(media_type, []):
                    vectorstore.add(
                        content=item["content"],
                        page=json.dumps(item["page"] if isinstance(item["page"], list) else [item["page"]]),
                        document_id=knowledge_id,
                        media_type=media_type,
                        source=json.dumps(item["source"] if isinstance(item["source"], list) else [item["source"]])
                    )

           # âœ… æ›´æ–°è³‡æ–™åº«è³‡è¨Š
            chunks = vectorstore.list(knowledge_id)
            first_chunk = chunks[0]["content"] if chunks else ""
            knowledge.content = first_chunk
            knowledge.chunk = len(chunks)

            # âœ… åŸ·è¡Œæ—‹è½‰ï¼ˆé‡å°åŸå§‹æª”æ¡ˆï¼‰
            rotated_pages = result.get("rotate_page", [])
            if rotated_pages:
                log_msg = f"ğŸ” æ—‹è½‰åŸå§‹ PDF é ç¢¼ï¼š{rotated_pages}"
                print(log_msg)

                try:
                    doc = fitz.open(knowledge.file.path)
                    for page_number in rotated_pages:
                        page = doc[page_number - 1]
                        page.set_rotation((page.rotation + 90) % 360)
                        print(f"âœ… å·²æ—‹è½‰ç¬¬ {page_number} é ")
                    doc.saveIncr()  # å„²å­˜åŸå§‹æª”æ¡ˆï¼ˆin-placeï¼‰
                    doc.close()
                except Exception as e:
                    print(f"âŒ ç„¡æ³•æ—‹è½‰ PDFï¼š{e}")

            # âœ… å„²å­˜è™•ç†å®Œæˆç‹€æ…‹
            knowledge.processing_status = "done"
            knowledge.save()


    except Exception as e:
        knowledge.processing_status = "error"
        knowledge.save()
        print(f"âŒ è™•ç†å¤±æ•—ï¼š{e}")

    # âœ… ç„¡è«–æ˜¯å¦æˆåŠŸéƒ½ç¹¼çºŒè™•ç†ä¸‹ä¸€ç­†
    next_knowledge = Knowledge.objects.filter(processing_status="pending").order_by("created_at").first()
    if next_knowledge:
        process_pdf_background(next_knowledge.id)
