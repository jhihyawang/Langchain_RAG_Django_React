# âœ… å‡è¨­ conv_res å·²ç¶“å¾ doc_converter.convert(...) åŸ·è¡Œå®Œç•¢
# æ­¤æ®µç¨‹å¼å°‡é€ä¸€å–å‡ºæ¯å¼µè¡¨æ ¼ï¼Œä½¿ç”¨ table_to_sentences å°‡å…¶è½‰ç‚ºèªæ„å¥ä¸¦å°å‡º

from typing import List

def table_to_sentences(df: pd.DataFrame, orientation: str = "auto") -> List[str]:
    def is_vertical(df):
        first_col = df.iloc[:, 0]
        score = 0
        for val in first_col[: min(5, len(first_col))]:
            if isinstance(val, str) and len(val) <= 15 and not any(char.isdigit() for char in val):
                score += 1
        return score >= 0.6 * min(5, len(first_col))

    sentences = []
    if orientation == "auto":
        orientation = "vertical" if is_vertical(df) else "horizontal"

    if orientation == "horizontal":
        for idx, row in df.iterrows():
            line = []
            for col, val in row.items():
                if pd.notna(val) and str(val).strip() != "":
                    line.append(f"{col.strip()}: {str(val).strip()}")
            if line:
                sentences.append("; ".join(line))

    elif orientation == "vertical":
        header = df.columns.tolist()
        for row in df.itertuples(index=False):
            key = str(row[0]).strip()
            for i in range(1, len(row)):
                value = row[i]
                if pd.notna(value) and str(value).strip() != "":
                    col_name = header[i]
                    sentences.append(f"{key} - {col_name}: {str(value).strip()}")

    return sentences

# ğŸ” é€ä¸€è™•ç†æ¯å¼µè¡¨æ ¼ï¼Œè½‰ç‚ºèªæ„å¥ä¸¦åˆ—å°
all_table_sentences = []

for table_ix, table in enumerate(conv_res.document.tables):
    table_df: pd.DataFrame = table.export_to_dataframe()
    sentences = table_to_sentences(table_df)
    all_table_sentences.append({
        "table_index": table_ix + 1,
        "sentences": sentences
    })

# å±•é–‹æˆè¡¨æ ¼é¡¯ç¤º
flat_records = []
for entry in all_table_sentences:
    for s in entry["sentences"]:
        flat_records.append({"Table #": entry["table_index"], "Sentence": s})

import ace_tools as tools; tools.display_dataframe_to_user(name="è¡¨æ ¼èªæ„å¥çµæœ", dataframe=pd.DataFrame(flat_records))
