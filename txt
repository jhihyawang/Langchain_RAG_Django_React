import os
from io import BytesIO
from PIL import Image
from docling.pipeline import PdfPipelineOptions, EasyOcrOptions, TableFormerMode
from docling.converter import DocumentConverter
from docling.input_format import InputFormat, PdfFormatOption
from docling.backend import DoclingParseDocumentBackend
import ollama

def summarize_image_with_llm(image_path, prompt="è«‹è©³ç´°æè¿°é€™å¼µåœ–ç‰‡çš„å…§å®¹ï¼Œè‹¥æ˜¯åœ–è¡¨è«‹èªªæ˜å…¶è¶¨å‹¢èˆ‡é—œéµæ•¸æ“š"):
    system_prompt = (
        "ä½ æ˜¯ä¸€ä½é‡å°åœ–ç‰‡é€²è¡Œåˆ†æèˆ‡å…§å®¹é‚„åŸçš„åŠ©æ‰‹ï¼Œè«‹å›å‚³ç´”å…§å®¹æ‘˜è¦ã€‚"
        "è‹¥æ˜¯åœ–ç‰‡ä¸­åŒ…å«æ–‡å­—è«‹ç›¡å¯èƒ½é‚„åŸã€‚"
        "è‹¥æ˜¯åœ–è¡¨ï¼Œè«‹æŒ‡å‡ºåœ–è¡¨é¡å‹ã€å„è»¸æ„ç¾©ã€è¶¨å‹¢èˆ‡é—œéµæ•¸æ“šã€‚"
    )

    try:
        response = ollama.chat(
            model="gemma3:4b",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": prompt, "images": [image_path]}
            ]
        )
        return response["message"]["content"]
    except Exception as e:
        return f"âŒ åœ–åƒæ‘˜è¦éŒ¯èª¤: {str(e)}"

def parse_pdf_with_docling(source_pdf_path: str, artifacts_path: str):
    pipeline_options = PdfPipelineOptions()
    pipeline_options.artifacts_path = artifacts_path
    pipeline_options.do_ocr = True
    pipeline_options.ocr_options = EasyOcrOptions(force_full_page_ocr=True)
    pipeline_options.ocr_options.lang = ["ch_tra", "en"]

    pipeline_options.generate_page_images = False
    pipeline_options.do_table_structure = True
    pipeline_options.table_structure_options.do_cell_matching = True
    pipeline_options.table_structure_options.mode = TableFormerMode.ACCURATE

    pipeline_options.generate_picture_images = True
    pipeline_options.do_picture_classification = True
    pipeline_options.do_code_enrichment = True
    pipeline_options.do_formula_enrichment = True

    backend = DoclingParseDocumentBackend
    doc_converter = DocumentConverter(
        format_options={
            InputFormat.PDF: PdfFormatOption(
                backend=backend,
                pipeline_options=pipeline_options
            )
        }
    )

    conversion_result = doc_converter.convert(source=source_pdf_path)
    doc = conversion_result.document

    result = []

    image_dir = os.path.join("media", "docling_images")
    os.makedirs(image_dir, exist_ok=True)

    for page in doc.pages:
        page_index = page.page_index if hasattr(page, "page_index") else 0
        page_number = page_index + 1
        markdown_blocks = []

        # åŸå§‹æ–‡å­—å…§å®¹
        page_content = page.export_to_markdown()
        markdown_blocks.append(page_content)

        # æ’å…¥æ¯å¼µåœ–ç‰‡æ‘˜è¦
        for i, img in enumerate(page.images):
            try:
                image_bytes = img.to_bytes()
                image = Image.open(BytesIO(image_bytes))

                image_path = os.path.join(image_dir, f"page_{page_number}_img_{i+1}.png")
                image.save(image_path)

                summary = summarize_image_with_llm(image_path)

                image_block = (
                    f"\n\n![åœ–ç¤º page_{page_number}_img_{i+1}](/{image_path})\n"
                    f"ğŸ–¼ï¸ **åœ–ç‰‡æ‘˜è¦**ï¼š\n{summary.strip()}"
                )
                markdown_blocks.append(image_block)
            except Exception as e:
                print(f"âš ï¸ ç¬¬ {page_number} é ç¬¬ {i+1} å¼µåœ–ç‰‡è™•ç†å¤±æ•—ï¼š{e}")

        final_markdown = "\n\n".join(markdown_blocks)
        result.append({
            "page": page_number,
            "content": final_markdown,
            "media_type": "text",  # å·²æ•´åˆæ–‡å­—+åœ–åƒæ‘˜è¦ï¼Œçµ±ä¸€ç‚º text
            "source": f"page_{page_number}"
        })

    return result
