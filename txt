@background(schedule=0)
def process_pdf_background(knowledge_id):
    try:
        knowledge = Knowledge.objects.get(id=knowledge_id)

        if knowledge.processing_status != 'pending':
            return

        knowledge.processing_status = 'processing'
        knowledge.save(update_fields=['processing_status'])

        pdf_path = knowledge.file.path

        # 1ï¸âƒ£ å»ºç«‹æ—‹è½‰åˆ¤æ–·å‰¯æœ¬
        rotation_input = pdf_path + ".rotation_check.pdf"
        shutil.copy(pdf_path, rotation_input)

        # 2ï¸âƒ£ é€²è¡Œæ—‹è½‰è™•ç†ï¼Œè¿”å›æ–°çš„ pdf_path
        rotator = PdfRotator(pdf_path=rotation_input, knowledge_id=knowledge_id, knowledge_title=knowledge.title)
        rotated_path = rotator.rotate()

        # 3ï¸âƒ£ æ ¹æ“šæ˜¯å¦æœ‰æ—‹è½‰æ±ºå®šæœ€çµ‚è¼¸å…¥è·¯å¾‘
        if rotated_path:
            final_pdf_path = rotated_path
        else:
            final_pdf_path = pdf_path

        # 4ï¸âƒ£ åŸ·è¡Œå…§å®¹æå–ï¼ˆé‡å°æœ€çµ‚ PDFï¼‰
        processor = PdfProcessor(pdf_path=final_pdf_path, knowledge_id=knowledge_id, knowledge_title=knowledge.title)
        success = processor.process_with_docling()

        if not success:
            knowledge.processing_status = 'error'
            knowledge.save(update_fields=['processing_status'])
            return

        # 5ï¸âƒ£ æ›´æ–° DB ç‹€æ…‹èˆ‡å…§å®¹
        vectorstore = VectorStoreHandler(db_path="chroma_user_db")
        chunks = vectorstore.list(knowledge_id)
        knowledge.content = chunks[0]['content'] if chunks else ""
        knowledge.chunk = len(chunks)
        knowledge.processing_status = 'done'
        knowledge.save(update_fields=['content', 'chunk', 'processing_status'])

        # ğŸ§¹ æ¸…é™¤ä¸­ç¹¼å‰¯æœ¬æª”æ¡ˆ
        if os.path.exists(rotation_input):
            os.remove(rotation_input)

    except Exception as e:
        knowledge.processing_status = 'error'
        knowledge.save(update_fields=['processing_status'])
        print(f"èƒŒæ™¯è™•ç†å¤±æ•—ï¼š{e}")



def rotate(self):
    rotated_pages = self.correction_direction()
    if rotated_pages:
        doc = fitz.open(self.pdf_path)
        for pg in rotated_pages:
            doc[pg - 1].set_rotation((doc[pg - 1].rotation + 90) % 360)

        rotated_output = self.pdf_path + ".rotated.pdf"
        doc.save(rotated_output, garbage=4, deflate=True, clean=True)
        doc.close()

        return rotated_output  # âœ… å›å‚³æ—‹è½‰å¾Œæª”æ¡ˆè·¯å¾‘
    else:
        return None  # âœ… ç„¡æ—‹è½‰ï¼Œæ˜ç¢ºå›å‚³ None
