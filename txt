from rest_framework.views import APIView
from rest_framework.response import Response
from FlagEmbedding import FlagReranker

# è¼‰å…¥ä¸€æ¬¡å°±å¥½ï¼Œå¯æ”¹ç‚º class å±¤ç´šå±¬æ€§æˆ– singleton
reranker = FlagReranker('BAAI/bge-reranker-base', use_fp16=True)

class QueryAPIView(APIView):
    def post(self, request):
        query = request.data.get("query", "")
        document_id = request.data.get("document_id")  # optional

        if not query:
            return Response({"error": "è«‹è¼¸å…¥å•é¡Œ"}, status=400)

        # ğŸ” Step 1: åŸå§‹å‘é‡æª¢ç´¢
        if document_id:
            results = vectorstore.similarity_search(query, k=10, filter={"document_id": document_id})
        else:
            results = vectorstore.similarity_search(query, k=10)

        if not results:
            return Response({"answer": "æ‰¾ä¸åˆ°ç›¸é—œå…§å®¹ã€‚"})

        # ğŸ“Š Step 2: ç”¨ reranker é‡æ–°æ’åº
        texts = [doc.page_content for doc in results]
        scores = reranker.compute_score(query, texts)
        reranked = sorted(zip(results, scores), key=lambda x: x[1], reverse=True)

        top_chunks = [doc for doc, _ in reranked[:5]]  # å–å‰ 5 æ®µ
        context = "\n".join([doc.page_content for doc in top_chunks])

        # ğŸ’¬ Step 3: å‘¼å« LLM å›ç­”ï¼ˆä½ å¯ç”¨ OpenAI / Ollama / ChatCompletionï¼‰
        answer = llm.generate(context + "\n\n" + query)

        return Response({
            "answer": answer,
            "chunks": [doc.page_content for doc in top_chunks],  # å¯é¸å›å‚³
            "scores": [float(s) for _, s in reranked[:5]]
        })
