import json
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain_chroma import Chroma
from langchain_huggingface import HuggingFaceEmbeddings

class VectorStoreHandler:
    def __init__(self, db_path="chroma_user_db", embed_model="BAAI/bge-m3"):
        self.embedder = HuggingFaceEmbeddings(model_name=embed_model)
        self.vectorstore = Chroma(persist_directory=db_path, embedding_function=self.embedder)
        self.splitter = RecursiveCharacterTextSplitter(chunk_size=512, chunk_overlap=128)

    def add(self, content: str, media_type: str, page: int, document_id: str, source: str, title: str) -> bool:
        if not content.strip():
            return False
        chunks = self.splitter.split_text(content)
        metadatas = [
            {
                "media_type": media_type,
                "page_number": page,
                "document_id": document_id,
                "source": source,
                "title": title,
                "chunk_index": i,
            }
            for i in range(len(chunks))
        ]
        self.vectorstore.add_texts(chunks, metadatas=metadatas)
        print(f"âœ… å‘é‡å·²å„²å­˜ï¼š{media_type} ç¬¬ {page} é ï¼Œå…± {len(chunks)} æ®µ")
        return True

    def list(self, document_id: str) -> list:
        try:
            res = self.vectorstore._collection.get(
                where={"document_id": document_id},
                include=["ids", "documents", "metadatas"]
            )
            return [
                {
                    "id": res["ids"][i],
                    "content": res["documents"][i],
                    "chunk_index": res["metadatas"][i].get("chunk_index", i),
                    "page_number": res["metadatas"][i].get("page_number"),
                    "media_type": res["metadatas"][i].get("media_type"),
                    "source": res["metadatas"][i].get("source"),
                    "title": res["metadatas"][i].get("title"),
                }
                for i in range(len(res["documents"]))
            ]
        except Exception as e:
            print(f"âŒ æŸ¥è©¢å¤±æ•—: {e}")
            return []

    def delete(self, document_id: str) -> bool:
        try:
            self.vectorstore._collection.delete(where={"document_id": document_id})
            print(f"ğŸ—‘ å·²åˆªé™¤ document_id={document_id} çš„å‘é‡è³‡æ–™")
            return True
        except Exception as e:
            print(f"âŒ åˆªé™¤å¤±æ•—: {e}")
            return False

    def update(self, chunk_id: str, new_content: str) -> str:
        """
        æ›´æ–°æŒ‡å®š chunk çš„æ–‡æœ¬å…§å®¹ï¼Œä¿ç•™åŸ chunk_idã€‚
        åˆ©ç”¨ ChromaDB åŸç”Ÿ updateï¼Œé¿å…é‡æ–°åˆªé™¤èˆ‡æ–°å¢ã€‚
        è¿”å›æ›´æ–°å¾Œçš„ chunk_idï¼Œå¤±æ•—æ™‚è¿”å› Noneã€‚
        """
        try:
            # ç›´æ¥æ›´æ–° document æ¬„ä½
            self.vectorstore._collection.update(
                ids=[chunk_id],
                documents=[new_content]
            )
            print(f"ğŸ”„ å·²æ›´æ–° chunk_id={chunk_id}")
            return chunk_id
        except Exception as e:
            print(f"âŒ æ›´æ–°å¤±æ•—: {e}")
            return None

    def delete_chunk_by_id(self, chunk_id: str) -> bool:
        try:
            self.vectorstore._collection.delete(ids=[chunk_id])
            print(f"ğŸ—‘ å·²åˆªé™¤ chunk_id={chunk_id} çš„å‘é‡è³‡æ–™")
            return True
        except Exception as e:
            print(f"âŒ åˆªé™¤ chunk å¤±æ•—: {e}")
            return False

    def get_chunks_by_document_id(self, document_id: str) -> list:
        try:
            res = self.vectorstore._collection.get(
                where={"document_id": document_id},
                include=["ids", "documents", "metadatas"]
            )
            return [
                {"id": res["ids"][i], **res["metadatas"][i], "content": res["documents"][i]}
                for i in range(len(res["documents"]))
            ]
        except Exception as e:
            print(f"âŒ æŸ¥è©¢ chunk ç™¼ç”ŸéŒ¯èª¤: {e}")
            return []

    def get_chunk_metadata_by_id(self, chunk_id: str) -> dict:
        try:
            res = self.vectorstore._collection.get(
                ids=[chunk_id],
                include=["metadatas"]
            )
            return res.get("metadatas", [{}])[0]
        except Exception as e:
            print(f"âŒ æŸ¥è©¢ chunk metadata å¤±æ•—: {e}")
            return {}
