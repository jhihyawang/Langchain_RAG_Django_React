import re
from langchain.text_splitter import RecursiveCharacterTextSplitter

def hybrid_chunk_markdown(md_text, chunk_size=500, chunk_overlap=100):
    # 切分為段落（包含表格、文字）
    splitter = RecursiveCharacterTextSplitter(
        chunk_size=chunk_size,
        chunk_overlap=chunk_overlap,
        separators=[
            "```", "\n### ", "\n## ", "\n# ",
            "\n- ", "\n* ", "\n1. ", "\n> ",
            "\n\n", "\n", ".", "!", "?", " "
        ]
    )
    sections = splitter.split_text(md_text)

    # 將表格與上下文合併（Hybrid）
    chunks = []
    buffer = ""
    for section in sections:
        if "|" in section and "---" in section:  # 偵測表格
            if buffer:
                chunks.append(buffer + "\n" + section)
                buffer = ""
            else:
                chunks.append(section)
        else:
            if len(buffer) + len(section) < chunk_size:
                buffer += "\n" + section
            else:
                chunks.append(buffer)
                buffer = section
    if buffer:
        chunks.append(buffer)
    
    return chunks


chunks = hybrid_chunk_markdown(your_markdown_text)
for i, chunk in enumerate(chunks):
    print(f"\n--- Chunk {i+1} ---\n{chunk}")
